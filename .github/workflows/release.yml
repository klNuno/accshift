name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (example: v0.1.1)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Resolve release tag
        id: release_tag
        shell: pwsh
        run: |
          $inputTag = "${{ github.event.inputs.tag }}"
          $tag = if (-not [string]::IsNullOrWhiteSpace($inputTag)) { $inputTag } else { "${env:GITHUB_REF_NAME}" }

          if (-not $tag.StartsWith("v")) {
            throw "Invalid tag '$tag'. Expected format: vX.Y.Z"
          }

          $version = $tag.TrimStart("v")
          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "Invalid tag '$tag'. Version is empty."
          }

          "tag=$tag" >> $env:GITHUB_OUTPUT
          "version=$version" >> $env:GITHUB_OUTPUT

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate versions against tag
        shell: pwsh
        run: |
          $tag = "${{ steps.release_tag.outputs.version }}"

          $packageVersion = (Get-Content package.json -Raw | ConvertFrom-Json).version
          $tauriVersion = (Get-Content src-tauri/tauri.conf.json -Raw | ConvertFrom-Json).version

          $cargoMatch = Select-String -Path src-tauri/Cargo.toml -Pattern '^version\s*=\s*"([^"]+)"' | Select-Object -First 1
          if (-not $cargoMatch) {
            throw "Could not read version from src-tauri/Cargo.toml"
          }
          $cargoVersion = $cargoMatch.Matches[0].Groups[1].Value

          if ($packageVersion -ne $tag -or $tauriVersion -ne $tag -or $cargoVersion -ne $tag) {
            throw "Version mismatch. tag=$tag package.json=$packageVersion tauri.conf.json=$tauriVersion Cargo.toml=$cargoVersion"
          }

      - name: Build Tauri bundles
        run: pnpm tauri build

      - name: Generate SHA256 checksums
        shell: pwsh
        run: |
          $bundleDir = "src-tauri/target/release/bundle"
          $files = @()
          $files += Get-ChildItem "$bundleDir/nsis/*.exe" -File -ErrorAction SilentlyContinue
          $files += Get-ChildItem "$bundleDir/msi/*.msi" -File -ErrorAction SilentlyContinue

          if ($files.Count -eq 0) {
            throw "No release artifacts found in $bundleDir"
          }

          $lines = $files | ForEach-Object {
            $hash = (Get-FileHash -Path $_.FullName -Algorithm SHA256).Hash.ToLower()
            "$hash  $($_.Name)"
          }

          $outFile = "$bundleDir/SHA256SUMS.txt"
          $lines | Set-Content -Path $outFile -Encoding ascii
          Get-Content $outFile

      - name: Generate release changelog
        shell: pwsh
        run: |
          $tag = "${{ steps.release_tag.outputs.tag }}"
          $prevTag = ""
          try {
            $prevTag = (git describe --tags --abbrev=0 "$tag^" 2>$null).Trim()
          } catch {
            $prevTag = ""
          }

          $range = if ([string]::IsNullOrWhiteSpace($prevTag)) { $tag } else { "$prevTag..$tag" }
          $raw = git log --reverse --pretty=format:"@@@%n%s%n%b" $range
          $entries = $raw -split "@@@\r?\n" | Where-Object { -not [string]::IsNullOrWhiteSpace($_.Trim()) }

          $notes = New-Object System.Collections.Generic.List[string]
          $notes.Add("## Changelog")
          $notes.Add("")

          foreach ($entry in $entries) {
            $lines = $entry -split "\r?\n"
            $subject = $lines[0].Trim()
            if ([string]::IsNullOrWhiteSpace($subject)) {
              continue
            }

            $notes.Add("- $subject")
            $bodyLines = $lines |
              Select-Object -Skip 1 |
              ForEach-Object { $_.Trim() } |
              Where-Object { $_ -like "- *" }

            foreach ($bodyLine in $bodyLines) {
              $notes.Add("  $bodyLine")
            }
          }

          if ($notes.Count -le 2) {
            $notes.Add("- No changelog entries found.")
          }

          Set-Content -Path RELEASE_NOTES.md -Value $notes -Encoding utf8
          Get-Content RELEASE_NOTES.md

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          draft: false
          generate_release_notes: false
          body_path: RELEASE_NOTES.md
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/SHA256SUMS.txt
