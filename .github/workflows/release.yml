name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate versions against tag
        shell: pwsh
        run: |
          $tag = "${env:GITHUB_REF_NAME}".TrimStart("v")
          if ([string]::IsNullOrWhiteSpace($tag)) {
            throw "Tag is empty. Expected format: vX.Y.Z"
          }

          $packageVersion = (Get-Content package.json -Raw | ConvertFrom-Json).version
          $tauriVersion = (Get-Content src-tauri/tauri.conf.json -Raw | ConvertFrom-Json).version

          $cargoMatch = Select-String -Path src-tauri/Cargo.toml -Pattern '^version\s*=\s*"([^"]+)"' | Select-Object -First 1
          if (-not $cargoMatch) {
            throw "Could not read version from src-tauri/Cargo.toml"
          }
          $cargoVersion = $cargoMatch.Matches[0].Groups[1].Value

          if ($packageVersion -ne $tag -or $tauriVersion -ne $tag -or $cargoVersion -ne $tag) {
            throw "Version mismatch. tag=$tag package.json=$packageVersion tauri.conf.json=$tauriVersion Cargo.toml=$cargoVersion"
          }

      - name: Build Tauri bundles
        run: pnpm tauri build

      - name: Generate SHA256 checksums
        shell: pwsh
        run: |
          $bundleDir = "src-tauri/target/release/bundle"
          $files = @()
          $files += Get-ChildItem "$bundleDir/nsis/*.exe" -File -ErrorAction SilentlyContinue
          $files += Get-ChildItem "$bundleDir/msi/*.msi" -File -ErrorAction SilentlyContinue

          if ($files.Count -eq 0) {
            throw "No release artifacts found in $bundleDir"
          }

          $lines = $files | ForEach-Object {
            $hash = (Get-FileHash -Path $_.FullName -Algorithm SHA256).Hash.ToLower()
            "$hash  $($_.Name)"
          }

          $outFile = "$bundleDir/SHA256SUMS.txt"
          $lines | Set-Content -Path $outFile -Encoding ascii
          Get-Content $outFile

      - name: Create GitHub release (draft)
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/SHA256SUMS.txt
